<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 18 | The Grand Reveal</title>
    
    <!-- SF Pro Style Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">
    
    <!-- GSAP Master Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --apple-blue: #0071e3;
            --deep-navy: #000a12;
            --glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--deep-navy);
            color: #fff;
            font-family: 'Inter', -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, #001d3d 0%, #000 100%);
        }

        /* --- Apple-Style Glass Container --- */
        .viewport {
            width: 90%; max-width: 500px; height: 1200px;
            background: var(--glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 0.5px solid var(--border);
            border-radius: 42px;
            position: relative;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; overflow: hidden;
            z-index: 10;
        }

        .stage { position: absolute; width: 100%; height: 100%; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .hidden { display: none !important; opacity: 0; }

        /* --- Typography --- */
        .hero-title { font-family: 'Playfair Display', serif; font-size: 3.2rem; line-height: 1.1; margin-bottom: 15px; color: #fff; }
        .hero-subtitle { font-weight: 300; font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.5; margin-bottom: 30px; }
        .conclusion-text { font-size: 1.05rem; line-height: 1.6; font-weight: 300; opacity: 0.8; margin-top: 20px; }

        /* --- Interactions --- */
        .orb-outer { width: 140px; height: 140px; border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.5s; }
        .orb-inner { width: 100px; height: 100px; background: var(--apple-blue); border-radius: 50%; box-shadow: 0 0 40px var(--apple-blue); animation: pulse 3s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 60px #00f2ff; } }

        .video-player { width: 100%; border-radius: 24px; overflow: hidden; background: #000; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        video { width: 100%; display: block; }

        .cake-3d { position: relative; width: 160px; height: 90px; background: #1a1a1a; border-radius: 16px; margin: 40px 0; border-top: 6px solid var(--apple-blue); cursor: pointer; }
        .candle { width: 8px; height: 35px; background: #fff; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); }
        .flame { width: 14px; height: 22px; background: #00f2ff; border-radius: 50%; position: absolute; top: -22px; box-shadow: 0 0 20px #00f2ff; animation: flicker 0.1s infinite; }

        /* --- Photo Stack --- */
        .stack-area { position: relative; width: 100%; height: 350px; display: flex; align-items: center; justify-content: center; margin-top: 20px; }
        .photo-card { position: absolute; width: 220px; height: 280px; background: #fff; padding: 12px 12px 48px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 4px; cursor: grab; }
        .photo-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 2px; background: linear-gradient(45deg, #001d3d, #0071e3); }
        .photo-card p { position: absolute; bottom: 12px; left: 0; width: 100%; color: #1d1d1f; font-family: 'Playfair Display'; font-style: italic; font-size: 1.1rem; }

        /* --- Apple Buttons --- */
        .apple-btn { background: #fff; color: #000; border: none; padding: 14px 32px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .apple-btn:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 10px 20px rgba(255,255,255,0.1); }
        .unmute-btn { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-size: 0.7rem; margin-top: 15px; cursor: pointer; }

        @keyframes flicker { 0% { opacity: 0.9; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="viewport">
        <!-- Stage 1: The Intro -->
        <div id="stage-1" class="stage">
            <h1 class="hero-title">Blue.</h1>
            <p class="hero-subtitle">Hold the light to unlock</p>
            <div class="orb-outer" onmousedown="startApp()" ontouchstart="startApp()">
                <div class="orb-inner"></div>
            </div>
        </div>

        <!-- Stage 2: The Cinema -->
        <div id="stage-2" class="stage hidden">
            <p class="hero-subtitle">Chapter 18</p>
            <div class="video-player">
                <video id="vid" playsinline muted loop>
                    <source src="birthday_video.mp4" type="video/mp4">
                </video>
            </div>
            <button class="unmute-btn" onclick="document.getElementById('vid').muted = false">ðŸ”Š UNMUTE CINEMA</button>
            <button class="apple-btn" style="margin-top:20px;" onclick="nextStage(3)">Continue</button>
        </div>

        <!-- Stage 3: The Card -->
        <div id="stage-3" class="stage hidden">
            <h1 class="hero-title" style="font-size: 2.2rem;">Adulthood looks <br>good on you.</h1>
            <p class="conclusion-text" style="width:85%;">In every shade of blue, I see the calm, the depth, and the beauty that defines you.</p>
            <button class="apple-btn" style="margin-top:40px;" onclick="nextStage(4)">Make a Wish</button>
        </div>

        <!-- Stage 4: The Ritual -->
        <div id="stage-4" class="stage hidden">
            <p class="hero-subtitle">Blow into the microphone</p>
            <div class="cake-3d" onclick="blowCandle()">
                <div class="candle"><div id="flame" class="flame"></div></div>
            </div>
            <p id="mic-hint" style="font-size: 0.7rem; opacity: 0.4;">OR TAP TO BLOW</p>
            <button id="mem-btn" class="apple-btn hidden" onclick="nextStage(5)">See Archives</button>
        </div>

        <!-- Stage 5: The Archives -->
        <div id="stage-5" class="stage hidden">
            <h1 class="hero-title" style="font-size: 2rem;">Memories.</h1>
            <p class="hero-subtitle">Toss them away to see more</p>
            <div class="stack-area" id="stack">
                <div class="photo-card" style="z-index:3; transform: rotate(-4deg);"><img src="p3.jpg"> <p>It's</p></div>
                <div class="photo-card" style="z-index:2; transform: rotate(3deg);"><img src="p2.jpg"> <p>Almost</p></div>
                <div class="photo-card" style="z-index:1; transform: rotate(-2deg);"><img src="p1.jpg"> <p>A year now!</p></div>
            </div>
            <button class="apple-btn" style="margin-top:20px;" onclick="nextStage(6)">The Final Chapter</button>
        </div>

        <!-- Stage 6: The Conclusion -->
        <div id="stage-6" class="stage hidden">
            <p class="hero-subtitle">Happy 18th Birthday</p>
            <h1 class="hero-title" style="font-size: 4rem; margin-bottom:0;">18.</h1>
            <p class="hero-subtitle">A New Beginning</p>
            <div style="width: 80%; height: 1px; background: var(--border); margin: 50px 0;"></div>
            <p class="conclusion-text">
                Ek saal pehle hum mile the for the very first time, aur uss din kabhi socha bhi nahi tha ki tu meri life ka itna important hissa ban jayegi. Sirf ek saal mein hi tu mere liye mere purane doston se bhi zyada special ho gayi. Boards ke stress aur sleepless nights ke beech destiny ne humein milaya, aur wahi se ek dosti shuru hui jo aaj meri life ki sabse beautiful blessing hai.

Humari memoriesâ€”laughs, talks, silence, supportâ€”har moment priceless hai. Tere ups and downs mein tera shoulder banna aur tujhe strong bante hue dekhna means everything to me. Tu sirf meri best friend nahi, meri safe place hai.

Dil se dua hai ki humara bond hamesha aisa hi strong, honest aur unbreakable rahe. Tu greatness ke liye bani haiâ€”future physiotherapist, future doctorâ€”healing people with both skill and a kind heart.

May this birthday bring you endless happiness, success, love, and peace. Keep shining, keep dreaming, and never lose that beautiful sparkle in your heart.

Have the most magical birthday, Nia ðŸ’–ðŸŽ‰
Always by your side, always proud of you.
            </p>
            <p style="font-family:'Playfair Display'; margin-top:25px; font-size:1.2rem;">With all my love.</p>
        </div>
    </div>

    <script>
        // --- 1. PRO AUDIO SETUP ---
        const audio = new Audio('song.mp3');
        audio.volume = 0.1; // Professional 10% volume
        audio.loop = true;
        let started = false;

        function startApp() {
            if(!started) { audio.play(); started = true; nextStage(2); }
        }

        // --- 2. SMOOTH STAGE NAVIGATION ---
        let currentStage = 1;
        function nextStage(n) {
            const cur = document.getElementById(`stage-${currentStage}`);
            const nxt = document.getElementById(`stage-${n}`);
            const vid = document.getElementById('vid');

            gsap.to(cur, { opacity: 0, y: -30, scale: 0.95, duration: 0.8, ease: "expo.out", onComplete: () => {
                cur.classList.add('hidden');
                nxt.classList.remove('hidden');
                gsap.fromTo(nxt, { opacity: 0, y: 30, scale: 1.05 }, { opacity: 1, y: 0, scale: 1, duration: 1, ease: "expo.out" });
            }});

            if(n === 2) { audio.pause(); vid.play(); }
            if(n === 3) { vid.pause(); audio.play(); }
            if(n === 4) initMic();
            if(n === 5) initDraggable();
            if(n === 6) confetti({ particleCount: 250, spread: 100, origin: { y: 0.6 }, colors: ['#0071e3', '#ffffff', '#ade8f4'] });
            
            currentStage = n;
        }

        // --- 3. MICROPHONE BLOW LOGIC ---
        function initMic() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    const ctx = new AudioContext();
                    const ana = ctx.createAnalyser();
                    const mic = ctx.createMediaStreamSource(stream);
                    mic.connect(ana);
                    const data = new Uint8Array(ana.frequencyBinCount);

                    function check() {
                        if(currentStage !== 4) return;
                        ana.getByteFrequencyData(data);
                        let sum = data.reduce((a, b) => a + b);
                        if(sum / data.length > 60) { blowCandle(); stream.getTracks().forEach(t => t.stop()); }
                        else requestAnimationFrame(check);
                    }
                    check();
                }).catch(() => { document.getElementById('mic-hint').innerText = "TAP TO BLOW"; });
            }
        }

        function blowCandle() {
            gsap.to("#flame", { scale: 0, opacity: 0, duration: 0.5 });
            confetti({ particleCount: 150, spread: 70, colors: ['#0071e3', '#ffffff'] });
            document.getElementById('mem-btn').classList.remove('hidden');
            document.getElementById('mic-hint').style.display = 'none';
        }

        // --- 4. PHYSICS-BASED DRAGGABLE ---
        function initDraggable() {
            gsap.registerPlugin(Draggable);
            Draggable.create(".photo-card", {
                onDragStart: function() { gsap.to(this.target, { scale: 1.05, duration: 0.3 }); },
                onRelease: function() {
                    gsap.to(this.target, { scale: 1, duration: 0.3 });
                    if(Math.abs(this.x) > 150 || Math.abs(this.y) > 150) {
                        gsap.to(this.target, { opacity: 0, duration: 0.5 });
                    }
                }
            });
        }
    </script>
</body>
</html>